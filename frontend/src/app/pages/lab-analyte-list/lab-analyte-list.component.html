<div class="container mt-4">
  <h2>Lab Analyte Result List</h2>
  <button class="btn btn-primary mb-3" (click)="openCreateModal()">Create New Lab Analyte Result</button>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Lab Test</th>
        <th>Analyte LOINC</th>
        <th>Value</th>
        <th>Unit</th>
        <th>Ref. Low</th>
        <th>Ref. High</th>
        <th>Interpretation</th>
        <th>Version</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let analyte of labAnalyteResults">
        <td>{{ analyte.id }}</td>
        <td>{{ getLabTestName(analyte.lab_test_id) }}</td>
        <td>{{ analyte.loinc_code }}</td>
        <td>{{ analyte.value }}</td>
        <td>{{ analyte.unit }}</td>
        <td>{{ analyte.reference_low || 'N/A' }}</td>
        <td>{{ analyte.reference_high || 'N/A' }}</td>
        <td>{{ analyte.interpretation || 'N/A' }}</td>
        <td>{{ analyte.version }}</td>
        <td>
          <button class="btn btn-sm btn-warning me-2" (click)="openUpdateModal(analyte)">Update</button>
          <button class="btn btn-sm btn-danger" (click)="openDeleteModal(analyte)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Create LabAnalyteResult Modal -->
<div class="modal fade" id="createLabAnalyteModal" tabindex="-1" aria-labelledby="createLabAnalyteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createLabAnalyteModalLabel">Create Lab Analyte Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="onCreateSubmit()">
          <div class="mb-3">
            <label for="createAnalyteLabTestId" class="form-label">Lab Test <span class="text-danger">*</span></label>
            <select class="form-control" id="createAnalyteLabTestId" [(ngModel)]="createFormModel.lab_test_id" name="lab_test_id" required>
              <option [ngValue]="undefined" disabled selected>Select Lab Test</option>
              <option *ngFor="let lt of labTests" [value]="lt.id">{{ getLabTestName(lt.id) }}</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="createAnalyteReferenceRange" class="form-label">Reference Range <span class="text-danger">*</span></label>
            <select class="form-control" id="createAnalyteReferenceRange" (change)="onReferenceRangeChange($event)" name="reference_range" required>
              <option [value]="null" disabled selected>Select Reference Range</option>
              <option *ngFor="let range of referenceRanges" [value]="range.loinc_code">
                {{ getReferenceRangeDisplay(range.loinc_code) }}
              </option>
            </select>
            <small class="text-muted" *ngIf="createFormModel.loinc_code">
              Selected: LOINC {{ createFormModel.loinc_code }}, 
              Range: {{ createFormModel.reference_low || 'n/a' }}-{{ createFormModel.reference_high || 'n/a' }} {{ createFormModel.unit }}
            </small>
          </div>
          
          <div class="mb-3">
            <label for="createAnalyteValue" class="form-label">Value <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="createAnalyteValue" [(ngModel)]="createFormModel.value" name="value" required>
            <small class="text-muted" *ngIf="createFormModel.unit">Unit: {{ createFormModel.unit }}</small>
          </div>
          
          <!-- Hidden inputs to store the values set by onReferenceRangeChange -->
          <input type="hidden" [(ngModel)]="createFormModel.loinc_code" name="loinc_code">
          <input type="hidden" [(ngModel)]="createFormModel.unit" name="unit">
          <input type="hidden" [(ngModel)]="createFormModel.reference_low" name="reference_low">
          <input type="hidden" [(ngModel)]="createFormModel.reference_high" name="reference_high">
          <input type="hidden" [(ngModel)]="createFormModel.interpretation" name="interpretation">
          
          <button type="submit" class="btn btn-primary">Create</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Update LabAnalyteResult Modal -->
<div class="modal fade" id="updateLabAnalyteModal" tabindex="-1" aria-labelledby="updateLabAnalyteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateLabAnalyteModalLabel">Update Lab Analyte Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="onUpdateSubmit()">
          <input type="hidden" [(ngModel)]="updateFormModel.id" name="id_update">
          <div class="mb-3">
            <label for="updateAnalyteLabTestId" class="form-label">Lab Test <span class="text-danger">*</span></label>
            <select class="form-control" id="updateAnalyteLabTestId" [(ngModel)]="updateFormModel.lab_test_id" name="lab_test_id_update" required>
              <option *ngFor="let lt of labTests" [value]="lt.id">{{ getLabTestName(lt.id) }}</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="updateAnalyteReferenceRange" class="form-label">Reference Range <span class="text-danger">*</span></label>
            <select class="form-control" id="updateAnalyteReferenceRange" (change)="onReferenceRangeChange($event, true)" name="reference_range_update" required>
              <option [value]="null" disabled>Select Reference Range</option>
              <option *ngFor="let range of referenceRanges" [value]="range.loinc_code" [selected]="range.loinc_code === updateFormModel.loinc_code">
                {{ getReferenceRangeDisplay(range.loinc_code) }}
              </option>
            </select>
            <small class="text-muted" *ngIf="updateFormModel.loinc_code">
              Selected: LOINC {{ updateFormModel.loinc_code }}, 
              Range: {{ updateFormModel.reference_low || 'n/a' }}-{{ updateFormModel.reference_high || 'n/a' }} {{ updateFormModel.unit }}
            </small>
          </div>
          
          <div class="mb-3">
            <label for="updateAnalyteValue" class="form-label">Value <span class="text-danger">*</span></label>
            <input type="number" step="0.01" class="form-control" id="updateAnalyteValue" [(ngModel)]="updateFormModel.value" name="value_update" required>
            <small class="text-muted" *ngIf="updateFormModel.unit">Unit: {{ updateFormModel.unit }}</small>
          </div>
          
          <!-- Hidden inputs to store the values set by onReferenceRangeChange -->
          <input type="hidden" [(ngModel)]="updateFormModel.loinc_code" name="loinc_code_update">
          <input type="hidden" [(ngModel)]="updateFormModel.unit" name="unit_update">
          <input type="hidden" [(ngModel)]="updateFormModel.reference_low" name="reference_low_update">
          <input type="hidden" [(ngModel)]="updateFormModel.reference_high" name="reference_high_update">
          <input type="hidden" [(ngModel)]="updateFormModel.interpretation" name="interpretation_update">
          <input type="hidden" [(ngModel)]="updateFormModel.version" name="version_update">
          
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete LabAnalyteResult Modal -->
<div class="modal fade" id="deleteLabAnalyteModal" tabindex="-1" aria-labelledby="deleteLabAnalyteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteLabAnalyteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete lab analyte result with ID: {{ analyteToDelete?.id }} (LOINC: {{ analyteToDelete?.loinc_code }})?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>
