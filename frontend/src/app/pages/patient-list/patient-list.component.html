<div class="container mt-4">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Patient List</h2>
    <button class="btn btn-success" (click)="openCreateModal()">Create New Patient</button>
</div>
  <table class="table table-striped">
    <thead>      <tr>
        <th>ID</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Sex</th>
        <th>Identifier</th>
        <th>Version</th>
        <th>Actions</th>      
      </tr>
    </thead>
    <tbody>
        <tr *ngFor="let patient of patients" (click)="openDetailsModal(patient)" style="cursor: pointer;">
            <td>{{ patient.id }}</td>
            <td>{{ patient.first_name }}</td>
            <td>{{ patient.last_name }}</td>
            <td>{{ patient.sex }}</td>
            <td>{{ patient.identifier }}</td>
            <td>{{ patient.version }}</td>
            <td (click)="$event.stopPropagation()">
            <button class="btn btn-sm btn-info me-2" (click)="openDetailsModal(patient)">Detail</button>
            <button class="btn btn-sm btn-primary me-2" (click)="openUpdateModal(patient)">Update</button>
            <button class="btn btn-sm btn-danger" (click)="openDeleteModal(patient)">Delete</button>
            </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Create Patient Modal -->
<div class="modal fade" id="createPatientModal" tabindex="-1" aria-labelledby="createPatientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createPatientModalLabel">Create Patient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="onCreateSubmit()"> <div class="mb-3">
            <label for="createFirstName" class="form-label">First Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="createFirstName" [(ngModel)]="patientToCreate.first_name" name="createFirstName" required>
          </div>
          <div class="mb-3">
            <label for="createLastName" class="form-label">Last Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="createLastName" [(ngModel)]="patientToCreate.last_name" name="createLastName" required>
          </div>
          <div class="mb-3">
            <label for="createSex" class="form-label">Sex <span class="text-danger">*</span></label>
            <select class="form-control" id="createSex" [(ngModel)]="patientToCreate.sex" name="createSex" required>
              <option value="" disabled selected>Select Sex</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="createIdentifier" class="form-label">Identifier  <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="createIdentifier" [(ngModel)]="patientToCreate.identifier" name="createIdentifier">
          </div>
          <button type="submit" class="btn btn-primary">Create Patient</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Update Patient Modal -->
<div class="modal fade" id="updatePatientModal" tabindex="-1" aria-labelledby="updatePatientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updatePatientModalLabel">Update Patient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form *ngIf="patientToUpdate" (ngSubmit)="onUpdateSubmit()">          <div class="mb-3">
            <label for="firstName" class="form-label">First Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="firstName" [(ngModel)]="patientToUpdate.first_name" name="firstName" required>
          </div>
          <div class="mb-3">
            <label for="lastName" class="form-label">Last Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="lastName" [(ngModel)]="patientToUpdate.last_name" name="lastName" required>
          </div>
          <div class="mb-3">
            <label for="sex" class="form-label">Sex <span class="text-danger">*</span></label>
            <select class="form-control" id="sex" [(ngModel)]="patientToUpdate.sex" name="sex" required>
              <option value="" disabled selected>Select Sex</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="identifier" class="form-label">Identifier  <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="identifier" [(ngModel)]="patientToUpdate.identifier" name="identifier">
          </div>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePatientModal" tabindex="-1" aria-labelledby="deletePatientModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deletePatientModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" (click)="cancelDelete()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete patient {{ patientToDelete?.first_name }} {{ patientToDelete?.last_name }}?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Patient Details Modal -->
<div class="modal fade" id="patientDetailsModal" tabindex="-1" aria-labelledby="patientDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">      <div class="modal-header">
        <h5 class="modal-title" id="patientDetailsModalLabel">Full Report of {{patientFullDetails?.first_name}} {{patientFullDetails?.last_name}}</h5>
        <button type="button" class="btn-close" (click)="closeDetailsModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="patientFullDetails" class="container">
          <!-- Patient Information Section -->
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Patient Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>ID:</strong> {{ patientFullDetails.id }}</p>
                  <p><strong>First Name:</strong> {{ patientFullDetails.first_name }}</p>
                  <p><strong>Last Name:</strong> {{ patientFullDetails.last_name }}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Sex:</strong> {{ patientFullDetails.sex }}</p>
                  <p><strong>Identifier:</strong> {{ patientFullDetails.identifier }}</p>
                  <p><strong>Version:</strong> {{ patientFullDetails.version }}</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Body Measurements Section -->
          <div class="card mb-4" *ngIf="patientFullDetails.body_measurements && patientFullDetails.body_measurements.length > 0">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">Body Measurements</h5>
            </div>
            <div class="card-body">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Record Time</th>
                    <th>Value</th>
                    <th>Unit</th>
                    <th>SNOMED Code</th>
                    <th>Version</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let measurement of patientFullDetails.body_measurements">
                    <td>{{ measurement.id }}</td>
                    <td>{{ measurement.record_time | date:'medium' }}</td>
                    <td>{{ measurement.value }}</td>
                    <td>{{ measurement.unit }}</td>
                    <td>{{ measurement.snomed_code }}</td>
                    <td>{{ measurement.version }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="alert alert-info" *ngIf="!patientFullDetails.body_measurements || patientFullDetails.body_measurements.length === 0">
            No body measurements available for this patient.
          </div>
          
          <!-- Compositions Section -->
          <div *ngIf="patientFullDetails.compositions && patientFullDetails.compositions.length > 0">
            <div *ngFor="let composition of patientFullDetails.compositions" class="card mb-4">
              <div class="card-header bg-info text-white">
                <h5 class="mb-0">Composition #{{ composition.id }}</h5>
                <small>Start Time: {{ composition.start_time | date:'medium' }} | Version: {{ composition.version }}</small>
              </div>
              <div class="card-body">
                <!-- Lab Tests -->
                <div *ngFor="let labTest of composition.lab_tests" class="mb-4">
                  <h5 class="border-bottom pb-2">Lab Test #{{ labTest.id }} - LOINC: {{ labTest.loinc_code }} - Description: {{labTest.description}}</h5>
                  
                  <!-- Specimen Information -->
                  <div *ngIf="labTest.specimen" class="card mb-3">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">Specimen</h6>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-6">
                          <p><strong>ID:</strong> {{ labTest.specimen.id }}</p>
                          <p><strong>Type:</strong> {{ labTest.specimen.type }}</p>
                          <p><strong>Collection Time:</strong> {{ labTest.specimen.collection_time | date:'medium' }}</p>
                        </div>
                        <div class="col-md-6">
                          <p><strong>SNOMED Code:</strong> {{ labTest.specimen.snomed_code }}</p>
                          <p><strong>Description:</strong> {{ labTest.specimen.description }}</p>
                          <p><strong>Version:</strong> {{ labTest.specimen.version }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                                    
                  <!-- Analytes -->
                  <div *ngIf="labTest.analytes && labTest.analytes.length > 0" class="card mb-3">
                    <div class="card-header bg-light">
                      <h6 class="mb-0">Analytes</h6>
                    </div>
                    <div class="card-body">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>LOINC Code</th>
                            <th>Value</th>
                            <th>Unit</th>
                            <th>Reference Range</th>
                            <th>Interpretation</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let analyte of labTest.analytes">
                            <td>{{ analyte.id }}</td>
                            <td>{{ analyte.loinc_code }}</td>
                            <td>{{ analyte.value }}</td>
                            <td>{{ analyte.unit }}</td>
                            <td>
                              <span *ngIf="analyte.reference_low !== null && analyte.reference_high !== null">
                                {{ analyte.reference_low }} - {{ analyte.reference_high }}
                              </span>
                              <span *ngIf="analyte.reference_low === null || analyte.reference_high === null">
                                N/A
                              </span>
                            </td>
                            <td>{{ analyte.interpretation || 'N/A' }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="alert alert-info" *ngIf="!patientFullDetails.compositions || patientFullDetails.compositions.length === 0">
            No compositions available for this patient.
          </div>
        </div>
        <div *ngIf="!patientFullDetails" class="text-center p-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading patient details...</p>
        </div>
      </div>      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">Close</button>
      </div>
    </div>
  </div>
</div>
